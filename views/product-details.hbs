<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Product Details - {{product.name}}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        .tag-badge {
            font-size: 0.85rem;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .carousel-item img {
            max-height: 300px;
            object-fit: contain;
        }
        .marketplace-badge {
            font-size: 0.8em;
            padding: 2px 5px;
            border-radius: 3px;
            margin-right: 5px;
        }
        .etsy-badge { background-color: #F56400; color: white; }
        .shopify-badge { background-color: #96BF48; color: white; }
        .product-image {
            max-width: 100%;
            border-radius: 4px;
        }
        .stock-good { color: #198754; }
        .stock-warning { color: #ffc107; }
        .stock-danger { color: #dc3545; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Inventory Manager</a>
            <div class="navbar-nav">
                <a class="nav-link active" href="/inventory">Inventory</a>
                <a class="nav-link" href="/orders">Orders</a>
                <a class="nav-link" href="/sync">Sync</a>
                <a class="nav-link" href="/settings">Settings</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {{#if flashMessages.success}}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{flashMessages.success}}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {{/if}}
        
        {{#if flashMessages.error}}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{flashMessages.error}}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {{/if}}
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>{{product.name}}</h2>
            <a href="/inventory" class="btn btn-outline-secondary">Back to Inventory</a>
        </div>

        <div class="row">
            <div class="col-md-8">
                <!-- Product Images -->
                {{#if product.etsy_data.images}}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Product Images</h5>
                    </div>
                    <div class="card-body">
                        <div id="productImages" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                {{#each product.etsy_data.images}}
                                <div class="carousel-item {{#if @first}}active{{/if}}">
                                    <img src="{{this.url}}" class="d-block mx-auto product-image" alt="{{this.alt}}">
                                </div>
                                {{/each}}
                            </div>
                            {{#if (eq (length product.etsy_data.images) 1)}}
                            {{else}}
                            <button class="carousel-control-prev" type="button" data-bs-target="#productImages" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#productImages" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                            {{/if}}
                        </div>
                    </div>
                </div>
                {{/if}}

                <!-- Basic Product Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Product Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-4">SKU</dt>
                                    <dd class="col-sm-8">{{product.sku}}</dd>
                                    
                                    <dt class="col-sm-4">Location</dt>
                                    <dd class="col-sm-8">{{product.location}}</dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-4">On Hand</dt>
                                    <dd class="col-sm-8">{{product.quantity_on_hand}}</dd>
                                    
                                    <dt class="col-sm-4">Committed</dt>
                                    <dd class="col-sm-8">{{product.quantity_committed}}</dd>

                                    <dt class="col-sm-4">Available</dt>
                                    <dd class="col-sm-8">
                                        <span class="{{#if (eq product.quantity_available 0)}}stock-danger{{else if (lt product.quantity_available 5)}}stock-warning{{else}}stock-good{{/if}}">
                                            {{product.quantity_available}}
                                        </span>
                                    </dd>
                                </dl>
                            </div>
                        </div>

                        {{#if product.properties}}
                        <h6 class="mt-3">Properties</h6>
                        <div class="row">
                            {{#each product.properties}}
                            <div class="col-md-4 mb-2">
                                <strong>{{@key}}:</strong> {{this}}
                            </div>
                            {{/each}}
                        </div>
                        {{/if}}
                    </div>
                </div>

                {{#if product.etsy_data.description}}
                <!-- Product Description -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Description</h5>
                    </div>
                    <div class="card-body">
                        <div class="product-description">
                            {{{product.etsy_data.description}}}
                        </div>
                    </div>
                </div>
                {{/if}}

                {{#if product.etsy_data.tags}}
                <!-- Product Tags -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Tags</h5>
                    </div>
                    <div class="card-body">
                        <div class="product-tags">
                            {{#each product.etsy_data.tags}}
                            <span class="badge bg-secondary tag-badge">{{this}}</span>
                            {{/each}}
                        </div>
                    </div>
                </div>
                {{/if}}
            </div>

            <div class="col-md-4">
                <!-- Marketplace Connections -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Marketplace Connections</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>
                                    <span class="marketplace-badge etsy-badge">Etsy</span>
                                    {{#if etsyConnected}}
                                    <span class="text-success"><i class="bi bi-check-circle-fill"></i> Connected</span>
                                    {{else}}
                                    <span class="text-secondary"><i class="bi bi-x-circle-fill"></i> Not Connected</span>
                                    {{/if}}
                                </span>
                                {{#if etsyConnected}}
                                <a href="https://www.etsy.com/listing/{{product.etsy_data.listing_id}}" target="_blank" class="btn btn-sm btn-outline-primary">
                                    View on Etsy
                                </a>
                                {{/if}}
                            </div>

                            {{#if etsyConnected}}
                            <div class="mt-2">
                                <strong>Listing ID:</strong> {{product.etsy_data.listing_id}}<br>
                                <strong>Price:</strong> {{product.etsy_data.price}} {{product.etsy_data.currency_code}}<br>
                                <strong>Quantity:</strong> {{product.etsy_data.quantity}}<br>
                                <strong>Last Synced:</strong> {{formatDate product.etsy_data.last_synced}}
                            </div>
                            {{/if}}
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>
                                    <span class="marketplace-badge shopify-badge">Shopify</span>
                                    {{#if shopifyConnected}}
                                    <span class="text-success"><i class="bi bi-check-circle-fill"></i> Connected</span>
                                    {{else}}
                                    <span class="text-secondary"><i class="bi bi-x-circle-fill"></i> Not Connected</span>
                                    {{/if}}
                                </span>
                                {{#if shopifyConnected}}
                                <a href="https://{{process.env.SHOPIFY_SHOP_NAME}}/products/{{product.shopify_data.handle}}" target="_blank" class="btn btn-sm btn-outline-success">
                                    View on Shopify
                                </a>
                                {{/if}}
                            </div>

                            {{#if shopifyConnected}}
                            <div class="mt-2">
                                <strong>Product ID:</strong> {{product.shopify_data.product_id}}<br>
                                {{#if product.shopify_data.variant_id}}
                                <strong>Variant ID:</strong> {{product.shopify_data.variant_id}}<br>
                                {{/if}}
                                <strong>Price:</strong> {{product.shopify_data.price}}<br>
                                <strong>Quantity:</strong> {{product.shopify_data.inventory_quantity}}<br>
                                <strong>Last Synced:</strong> {{formatDate product.shopify_data.last_synced}}
                            </div>
                            {{/if}}
                        </div>
                    </div>
                </div>

                <!-- Actions Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Actions</h5>
                    </div>
                    <div class="card-body">
                        {{#if etsyConnected}}
                        <button class="btn btn-info btn-lg w-100 mb-2 sync-product" data-sku="{{product.sku}}">
                            Sync from Etsy
                        </button>
                        {{/if}}

                        <button class="btn btn-primary btn-lg w-100 mb-2" id="editProductBtn">
                            Edit Product
                        </button>

                        <button class="btn btn-success btn-lg w-100 mb-2" id="adjustInventoryBtn">
                            Adjust Inventory
                        </button>
                    </div>
                </div>

                <!-- Raw Data (Advanced) -->
                <div class="card">
                    <div class="card-header">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="showRawData">
                            <label class="form-check-label" for="showRawData">Show Raw Data</label>
                        </div>
                    </div>
                    <div class="card-body d-none" id="rawDataContent">
                        <pre class="mb-0" style="max-height: 500px; overflow-y: auto;"><code>{{json product}}</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal fade" id="editProductModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProductForm">
                        <div class="mb-3">
                            <label for="editSku" class="form-label">SKU</label>
                            <input type="text" class="form-control" id="editSku" value="{{product.sku}}" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="editName" value="{{product.name}}" required>
                        </div>
                        <div class="mb-3">
                            <label for="editLocation" class="form-label">Storage Location</label>
                            <input type="text" class="form-control" id="editLocation" value="{{product.location}}">
                        </div>

                        {{#if product.properties}}
                        <h6 class="mt-4 mb-3">Properties</h6>
                        {{#each product.properties}}
                        <div class="mb-3">
                            <label for="prop_{{@key}}" class="form-label">{{@key}}</label>
                            <input type="text" class="form-control property-field" id="prop_{{@key}}" data-prop-name="{{@key}}" value="{{this}}">
                        </div>
                        {{/each}}
                        {{/if}}
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveProductChanges">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Adjust Inventory Modal -->
    <div class="modal fade" id="adjustInventoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adjust Inventory</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="adjustInventoryForm">
                        <div class="mb-3">
                            <label for="currentQty" class="form-label">Current Quantity on Hand</label>
                            <input type="number" class="form-control" id="currentQty" value="{{product.quantity_on_hand}}" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="adjustmentType" class="form-label">Adjustment Type</label>
                            <select class="form-select" id="adjustmentType">
                                <option value="add">Add Inventory</option>
                                <option value="remove">Remove Inventory</option>
                                <option value="set">Set Exact Quantity</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="adjustmentQty" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="adjustmentQty" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="adjustmentReason" class="form-label">Reason (Optional)</label>
                            <input type="text" class="form-control" id="adjustmentReason" placeholder="e.g. New shipment, Damaged, etc.">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveInventoryAdjustment">Save Adjustment</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Handle showing/hiding raw data
        document.getElementById('showRawData').addEventListener('change', (e) => {
            const rawDataContent = document.getElementById('rawDataContent');
            if (e.target.checked) {
                rawDataContent.classList.remove('d-none');
            } else {
                rawDataContent.classList.add('d-none');
            }
        });

        // Handle syncing product
        document.querySelector('.sync-product')?.addEventListener('click', async (e) => {
            const sku = e.target.dataset.sku;
            try {
                const response = await fetch(`/sync/product/${sku}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('Product synced successfully!');
                    location.reload();
                } else {
                    alert('Failed to sync product');
                }
            } catch (error) {
                console.error('Error syncing product:', error);
                alert('Error syncing product');
            }
        });

        // Edit Product Modal
        const editProductModal = new bootstrap.Modal(document.getElementById('editProductModal'));
        document.getElementById('editProductBtn').addEventListener('click', () => {
            editProductModal.show();
        });

        // Save Product Changes
        document.getElementById('saveProductChanges').addEventListener('click', async () => {
            const sku = document.getElementById('editSku').value;
            const name = document.getElementById('editName').value;
            const location = document.getElementById('editLocation').value;
            
            const properties = {};
            document.querySelectorAll('.property-field').forEach(field => {
                properties[field.dataset.propName] = field.value;
            });
            
            const data = {
                sku,
                name,
                location,
                properties
            };
            
            try {
                const response = await fetch('/inventory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ changes: [data] })
                });
                
                if (response.ok) {
                    alert('Product updated successfully!');
                    location.reload();
                } else {
                    alert('Failed to update product');
                }
            } catch (error) {
                console.error('Error updating product:', error);
                alert('Error updating product');
            }
        });

        // Adjust Inventory Modal
        const adjustInventoryModal = new bootstrap.Modal(document.getElementById('adjustInventoryModal'));
        document.getElementById('adjustInventoryBtn').addEventListener('click', () => {
            document.getElementById('adjustmentQty').value = '';
            adjustInventoryModal.show();
        });

        // Save Inventory Adjustment
        document.getElementById('saveInventoryAdjustment').addEventListener('click', async () => {
            const sku = '{{product.sku}}';
            const currentQty = parseInt(document.getElementById('currentQty').value);
            const adjustmentType = document.getElementById('adjustmentType').value;
            const adjustmentQty = parseInt(document.getElementById('adjustmentQty').value);
            const reason = document.getElementById('adjustmentReason').value;
            
            if (isNaN(adjustmentQty) || adjustmentQty < 0) {
                alert('Please enter a valid quantity');
                return;
            }
            
            let newQuantity;
            switch (adjustmentType) {
                case 'add':
                    newQuantity = currentQty + adjustmentQty;
                    break;
                case 'remove':
                    newQuantity = Math.max(0, currentQty - adjustmentQty);
                    break;
                case 'set':
                    newQuantity = adjustmentQty;
                    break;
            }
            
            try {
                const response = await fetch('/inventory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        changes: [{ 
                            sku, 
                            quantity_on_hand: newQuantity 
                        }]
                    })
                });
                
                if (response.ok) {
                    alert('Inventory adjusted successfully!');
                    location.reload();
                } else {
                    alert('Failed to adjust inventory');
                }
            } catch (error) {
                console.error('Error adjusting inventory:', error);
                alert('Error adjusting inventory');
            }
        });
    </script>
</body>
</html>